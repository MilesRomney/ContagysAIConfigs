services:
  litellm:
    image: 'ghcr.io/berriai/litellm-database:main-stable'
    depends_on:
      redis:
        condition: service_healthy
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    ports:
      - '4000:4000'
    environment:
      - SERVICE_URL_LITELLM_4000
      - 'LITELLM_LOG=${LITELLM_LOG:-ERROR}'
      - 'LITELLM_MODE=${LITELLM_MODE:-PRODUCTION}'
      - 'LITELLM_MASTER_KEY=${SERVICE_PASSWORD_MASTERKEY}'
      - 'LITELLM_SALT_KEY=${LITELLM_SALT_KEY}'
      - 'UI_USERNAME=${SERVICE_USER_UI}'
      - 'UI_PASSWORD=${SERVICE_PASSWORD_UI}'
      - 'DATABASE_URL=${DATABASE_URL}'
      - 'STORE_MODEL_IN_DB=${STORE_MODEL_IN_DB:-true}'
      - STORE_PROMPTS_IN_SPEND_LOGS=true
      - 'REDIS_HOST=${REDIS_HOST:-redis}'
      - 'REDIS_PORT=${REDIS_PORT:-6379}'
      - 'REDIS_PASSWORD=${REDIS_PASSWORD}'
      - 'OPENAI_API_KEY=${OPENAI_API_KEY}'
      - 'OPENAI_API_BASE=${OPENAI_API_BASE}'
      - 'ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}'
      - 'ANTHROPIC_API_BASE=${ANTHROPIC_API_BASE}'
      - 'VOYAGE_API_KEY=${VOYAGE_API_KEY}'
      - 'VOYAGE_API_BASE=${VOYAGE_API_BASE}'
    volumes:
      - 'litellm-config:/app/config-volume'
    healthcheck:
      test:
        - CMD
        - python
        - '-c'
        - "import requests as r;r.get('http://127.0.0.1:4000/health/liveliness').raise_for_status()"
      interval: 5s
      timeout: 5s
      retries: 3
    entrypoint:
      - /bin/sh
      - '-c'
      - "cat > /app/config.yaml << 'EOF'\nmodel_list: []\nlitellm_settings:\n  callbacks: [\"prometheus\"]\nEOF\nexec litellm --config /app/config.yaml --port 4000 --num_workers 8\n"
  redis:
    image: 'redis:7-alpine'
    command: 'redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}'
    volumes:
      - 'redis-data:/data'
    healthcheck:
      test:
        - CMD
        - redis-cli
        - '--no-auth-warning'
        - '-a'
        - '${REDIS_PASSWORD}'
        - ping
      interval: 5s
      timeout: 5s
      retries: 3
  prometheus:
    image: prom/prometheus
    depends_on:
      litellm:
        condition: service_healthy
    ports:
      - '9090:9090'
    volumes:
      - 'prometheus-data:/prometheus'
      -
        type: bind
        source: ./prometheus.yml
        target: /etc/prometheus/prometheus.yml
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=15d'
    restart: always
volumes:
  redis-data:
    driver: local
  prometheus-data:
    driver: local
  litellm-config:
    driver: local
